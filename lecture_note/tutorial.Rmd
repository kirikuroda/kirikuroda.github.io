```{r, include=FALSE}
source("common.R")
```

# チュートリアル {#tutorial}

## 早速手を動かす

まず、データ可視化用のパッケージであるggplot2を読み込んでみよう。パッケージは`library(パッケージ名)`で読み込むことができる。

```{r}
library(ggplot2)

# ※シャープ記号より後ろに書かれている内容はただのコメントアウト（＝注釈）
# コメントアウトなので何を書いても怒られない
# ハッシュタグではない
# 自分でコードを書くときはメモとして使うようにしよう
```

チュートリアル用のデータとして、Rにデフォルトで入っている`mtcars`を使うことにする。`mtcars`は自動車の燃費などに関するデータである（コンソールに`?mtcars`と入力すると詳細なヘルプをみることができる）。では、`str(データ)`で中身を確認してみよう。

```{r}
str(mtcars) # 中身を確認
```

11の変数（variable）と32の観測値（observation）が記録されている。32行×11列のスプレッドシートがあるのと同じ状態だと考えてほしい。`head(データ)`で先頭6行のデータを確認してみよう。

```{r}
head(mtcars) # 先頭6行を確認
```

変数は全部で11個あるが、まずは2つの変数に注目してみよう。その変数は、

- `disp`：エンジンの排気量（立方インチ）

- `mpg`：燃費（マイル／ガロン）

である。

素朴に思いつくのは、「排気量と燃費の相関関係はどうなっているか？」というものだろう。排気量と燃費はそれぞれ<u>**連続変数**</u>（continuous variable：量的変数、quantitative variableとも言う）なので、ここは<u>**散布図**</u>を描くのが妥当そうである。

---

では、ggplot2における可視化を、手順を追って見ていこう。

<br>

**1. <u>x軸とy軸にどの変数を対応づけたいかを考える**</u>

ggplot2でデータを可視化する際、最初に書かなければいけない基本のコードは`ggplot(data = データ, aes(x = x軸の変数, y = y軸の変数))`である。

(ref:tutorial-1) 背景のみのグラフ。

```{r, fig.cap = '(ref:tutorial-1)'}
ggplot(data = mtcars, aes(x = disp, y = mpg))
```

しかし、灰色の背景があるだけでデータはプロットされない。なぜなら、どのようなデザイン^[ggplot2において厳密にはレイヤー（layer）などと呼んだりするが、そこら辺は入門段階ではあまり気にしなくて良い。というか、ぶっちゃけ筆者自身も厳密なことはわかっていない。]でデータをプロットするかを指示していないからである。つまり、これだけではまだ足りない。

<br>

**2. <u>どのようなデザインでプロットしたいかを指示する**</u>

データをどのようなデザイン（geometry）でプロットしたいかを、`geom_xxxx()`で指定しなければならない。今回は散布図（データを点としてプロット）なので、`geom_point()`というコードを使う。

先程のコードに「+」でコードをつなげていくことでプロットできるようになる。

(ref:tutorial-2) 散布図。x軸は排気量、y軸は燃費を表している。

```{r, tutorial-2, fig.cap='(ref:tutorial-2)'}
ggplot(data = mtcars, aes(x = disp, y = mpg)) + # コードを読みやすくするため、「+」のところで改行すると良い
  geom_point() # データを点（point）としてデザインするためのコードを追加
```

完成。基本はこれだけである。

なお、ほとんどのグラフはx軸とy軸から構成されるので、実はコードの中に一々`x = disp`や`y = mpg`と書く必要はない。また、データについても自明なので、`data = mtcars`と書く必要もない。つまり、上のコードは下のように書くこともできる（これ以降、data, x, yは省略する）。

(ref:tutorial-3) コードは若干違うが、上のFigure \@ref(fig:tutorial-2)と全く同じ散布図。

```{r, fig.cap='(ref:tutorial-3)'}
ggplot(mtcars, aes(disp, mpg)) +
  geom_point()
```

<br>

**3. <u>変数を色（や形状）に対応づける**</u>

もちろん上の図ができた時点でOKだが、これだけではどうも味気ない。では、ここで一歩進んで、もう1つ変数を加えてみよう。その変数とは、

- `cyl`：シリンダーの個数（4, 6, or 8）

である。このとき「シリンダーの個数によって、排気量と燃費の関係は違うのではないか？」ということが思いつく。

それでは、`cyl`によって点の色を変えてみよう。以下のコードを書けばOKである。

(ref:tutorial-4) シリンダーの個数を点の色に対応づけた散布図。

```{r, fig.cap='(ref:tutorial-4)'}
ggplot(mtcars, aes(disp, mpg, color = cyl)) + # color = year を追加
  geom_point()
```

`aes()`に`color = cyl`を追加することで、`cyl`を色に対応づけることができた。

<br>

<u>**しかし、このグラフは厳密には間違っている。**</u>どこが間違っているのだろうか？　少し考えてみてほしい。

<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

**答え**

図の右側の青いバー（<u>**凡例**</u>；legend）を見ると、その横にシリンダーの個数が連続変数として1刻みで描かれれている（4,5,6,7,8）。しかし、実際のデータには4,6,8という3種類の値しかない。もちろん個数は連続的なものだが、この場合は<u>**離散変数**</u>（discrete variable；質的変数、qualitative/categorical/factor variableとも言う）として扱ったほうがデータの表現として妥当だろう^[変数が連続か離散かという区別は、可視化の上で結構重要なので意識しておくと良い。]。

この場合、`cyl`を`factor()`でくくると解決する。

(ref:tutorial-5) シリンダー数を離散変数とした上で色に対応づけた散布図。

```{r, tutorial-5, fig.cap='(ref:tutorial-5)'}
ggplot(mtcars, aes(disp, mpg, color = factor(cyl))) + # factor(cyl)に変更
  geom_point()
```

Rでは、`factor(変数)`とすることで、その変数を離散変数として扱うことができるようになる。その結果、凡例の表示も妥当なものとなった。


## まとめ

このように、ggplot2を使うと、数行のコードでそれなりに見栄えの良い図が描けるようになる。

手順をもう一度おさらいしよう。

**1. <u>x軸とy軸にどの変数を対応づけたいかを考える</u>**

  - **何（y軸）を何（x軸）に応じてプロットしたいかを考えるのが可視化の第一歩である。**

  - これが思いつけば可視化は大体うまくいったようなものである。

**2. <u>どのようなデザインでプロットしたいかを指示する</u>**

  - **データの性質（特に離散変数か連続変数か）に応じてデザインを決める。**

  - たとえば「x軸が連続変数でy軸が連続変数なら散布図」というように決める。こういうのは大体コンセンサスが取れている^[これはヒューリスティックであり、時には例外もある。しかし、大体の場合正しい。]ので、以降の章でそれを学んでいってほしい。
  
  - 今回は散布図しか描かなかったが、たとえば散布図の上に回帰直線を重ね書きする、というように、複数の表現を組み合わせてプロットすることも可能である。これは追々見ていくことにする。

**3. <u>変数を色（や形状）に対応づける</u>**

  - **x軸、y軸以外に追加したい変数がある場合は、色などに対応づける。**

  - まずは基本のプロットができるようになることを目指すので、細かい色の調整方法などは後の方で少しだけ解説する。

---

下に載せているのはあくまでごく一部だが、ggplot2では以下のデザイン（`geom_xxxx()`）を使うことが多い。

|geom                 |デザイン             |
|-------------------- |---------------------|
|geom_bar()           |棒グラフ             |
|geom_line()          |折れ線グラフ         |
|geom_point()         |散布図、点           |
|geom_errorbar()      |エラーバー           |
|geom_pointrange()    |点＋線               |
|geom_histogram()     |ヒストグラム         |
|geom_density()       |密度曲線             |
|geom_boxplot()       |箱ひげ図             |
|geom_violin()        |バイオリンプロット   |
|geom_area()          |面グラフ             |
|geom_smooth()        |関数のフィッティング |
|geom_text()          |テキスト             |

<br>

これもまたごく一部だが、変数は`x`、`y`、`color`だけでなく、以下の要素（`aes()`）にも対応づけることができる。

|aes()                |要素                 |
|-------------------- |---------------------|
|x                    |x軸                  |
|y                    |y軸                  |
|color                |枠の色               |
|fill                 |塗りつぶしの色       |
|linetype             |線の形               |
|size                 |線の太さ、点の大きさ |
|shape                |点の形               |

<br>

以降の章では、よく用いる可視化のパターンについて見ていくことにする。
