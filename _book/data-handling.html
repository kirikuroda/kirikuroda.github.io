<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>9 データハンドリング | いつか役に立つかもしれない資料</title>
  <meta name="description" content="9 データハンドリング | いつか役に立つかもしれない資料">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="9 データハンドリング | いつか役に立つかもしれない資料" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="9 データハンドリング | いつか役に立つかもしれない資料" />
  
  
  

<meta name="author" content="Kiri Kuroda">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="appearance.html">
<link rel="next" href="e382aae383b3e383a9e382a4e383b3e8b387e69699.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">トップページ</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>はじめに（服用上の注意）</a></li>
<li class="chapter" data-level="" data-path="rrstudio.html"><a href="rrstudio.html"><i class="fa fa-check"></i>RとRStudioのセットアップ</a><ul>
<li class="chapter" data-level="0.1" data-path="rrstudio.html"><a href="rrstudio.html#r"><i class="fa fa-check"></i><b>0.1</b> Rのインストール</a></li>
<li class="chapter" data-level="0.2" data-path="rrstudio.html"><a href="rrstudio.html#rstudio"><i class="fa fa-check"></i><b>0.2</b> RStudioのインストール</a></li>
<li class="chapter" data-level="0.3" data-path="rrstudio.html"><a href="rrstudio.html#section-0.3"><i class="fa fa-check"></i><b>0.3</b> パッケージのインストール</a></li>
<li class="chapter" data-level="0.4" data-path="rrstudio.html"><a href="rrstudio.html#section-0.4"><i class="fa fa-check"></i><b>0.4</b> パッケージの読み込み</a></li>
<li class="chapter" data-level="0.5" data-path="rrstudio.html"><a href="rrstudio.html#r"><i class="fa fa-check"></i><b>0.5</b> どうやってRのコードを実行するか？</a></li>
</ul></li>
<li class="part"><span><b>データの可視化</b></span></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> 可視化の重要性</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#section-1.1"><i class="fa fa-check"></i><b>1.1</b> アンスコムの例</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#ggplot2"><i class="fa fa-check"></i><b>1.2</b> 可視化のツール：ggplot2</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tutorial.html"><a href="tutorial.html"><i class="fa fa-check"></i><b>2</b> チュートリアル</a><ul>
<li class="chapter" data-level="2.1" data-path="tutorial.html"><a href="tutorial.html#section-2.1"><i class="fa fa-check"></i><b>2.1</b> 早速手を動かす</a></li>
<li class="chapter" data-level="2.2" data-path="tutorial.html"><a href="tutorial.html#section-2.2"><i class="fa fa-check"></i><b>2.2</b> まとめ</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="amount.html"><a href="amount.html"><i class="fa fa-check"></i><b>3</b> 数量</a><ul>
<li class="chapter" data-level="3.1" data-path="amount.html"><a href="amount.html#section-3.1"><i class="fa fa-check"></i><b>3.1</b> 棒グラフ</a><ul>
<li class="chapter" data-level="3.1.1" data-path="amount.html"><a href="amount.html#section-3.1.1"><i class="fa fa-check"></i><b>3.1.1</b> 基本の棒グラフ</a></li>
<li class="chapter" data-level="3.1.2" data-path="amount.html"><a href="amount.html#section-3.1.2"><i class="fa fa-check"></i><b>3.1.2</b> グルーピングされた棒グラフ</a></li>
<li class="chapter" data-level="3.1.3" data-path="amount.html"><a href="amount.html#section-3.1.3"><i class="fa fa-check"></i><b>3.1.3</b> 個数を表す棒グラフ</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="amount.html"><a href="amount.html#cleveland"><i class="fa fa-check"></i><b>3.2</b> Clevelandのドットプロット</a></li>
<li class="chapter" data-level="3.3" data-path="amount.html"><a href="amount.html#section-3.3"><i class="fa fa-check"></i><b>3.3</b> 練習問題</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="distribution.html"><a href="distribution.html"><i class="fa fa-check"></i><b>4</b> 分布</a><ul>
<li class="chapter" data-level="4.1" data-path="distribution.html"><a href="distribution.html#section-4.1"><i class="fa fa-check"></i><b>4.1</b> ヒストグラム</a><ul>
<li class="chapter" data-level="4.1.1" data-path="distribution.html"><a href="distribution.html#section-4.1.1"><i class="fa fa-check"></i><b>4.1.1</b> 基本のヒストグラム</a></li>
<li class="chapter" data-level="4.1.2" data-path="distribution.html"><a href="distribution.html#section-4.1.2"><i class="fa fa-check"></i><b>4.1.2</b> グルーピングされたヒストグラム</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="distribution.html"><a href="distribution.html#section-4.2"><i class="fa fa-check"></i><b>4.2</b> 密度プロット</a></li>
<li class="chapter" data-level="4.3" data-path="distribution.html"><a href="distribution.html#section-4.3"><i class="fa fa-check"></i><b>4.3</b> 箱ひげ図</a></li>
<li class="chapter" data-level="4.4" data-path="distribution.html"><a href="distribution.html#section-4.4"><i class="fa fa-check"></i><b>4.4</b> バイオリンプロット</a></li>
<li class="chapter" data-level="4.5" data-path="distribution.html"><a href="distribution.html#section-4.5"><i class="fa fa-check"></i><b>4.5</b> ストリッププロット</a></li>
<li class="chapter" data-level="4.6" data-path="distribution.html"><a href="distribution.html#-1"><i class="fa fa-check"></i><b>4.6</b> 練習問題</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="association.html"><a href="association.html"><i class="fa fa-check"></i><b>5</b> 連続変数間の関係</a><ul>
<li class="chapter" data-level="5.1" data-path="association.html"><a href="association.html#section-5.1"><i class="fa fa-check"></i><b>5.1</b> 基本の散布図</a></li>
<li class="chapter" data-level="5.2" data-path="association.html"><a href="association.html#section-5.2"><i class="fa fa-check"></i><b>5.2</b> グルーピングされた散布図</a></li>
<li class="chapter" data-level="5.3" data-path="association.html"><a href="association.html#section-5.3"><i class="fa fa-check"></i><b>5.3</b> 散布図行列</a></li>
<li class="chapter" data-level="5.4" data-path="association.html"><a href="association.html#section-5.4"><i class="fa fa-check"></i><b>5.4</b> オーバープロットへの対処</a></li>
<li class="chapter" data-level="5.5" data-path="association.html"><a href="association.html#-2"><i class="fa fa-check"></i><b>5.5</b> 練習問題</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="trend-data.html"><a href="trend-data.html"><i class="fa fa-check"></i><b>6</b> トレンドデータ</a><ul>
<li class="chapter" data-level="6.1" data-path="trend-data.html"><a href="trend-data.html#section-6.1"><i class="fa fa-check"></i><b>6.1</b> 基本の折れ線グラフ</a></li>
<li class="chapter" data-level="6.2" data-path="trend-data.html"><a href="trend-data.html#section-6.2"><i class="fa fa-check"></i><b>6.2</b> グルーピングされた折れ線グラフ</a></li>
<li class="chapter" data-level="6.3" data-path="trend-data.html"><a href="trend-data.html#section-6.3"><i class="fa fa-check"></i><b>6.3</b> 面グラフ</a></li>
<li class="chapter" data-level="6.4" data-path="trend-data.html"><a href="trend-data.html#-3"><i class="fa fa-check"></i><b>6.4</b> 練習問題</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="statistics.html"><a href="statistics.html"><i class="fa fa-check"></i><b>7</b> 推測統計</a><ul>
<li class="chapter" data-level="7.1" data-path="statistics.html"><a href="statistics.html#section-7.1"><i class="fa fa-check"></i><b>7.1</b> エラーバー</a></li>
<li class="chapter" data-level="7.2" data-path="statistics.html"><a href="statistics.html#section-7.2"><i class="fa fa-check"></i><b>7.2</b> 信頼区間</a></li>
<li class="chapter" data-level="7.3" data-path="statistics.html"><a href="statistics.html#section-7.3"><i class="fa fa-check"></i><b>7.3</b> 回帰直線などのフィッティング</a></li>
<li class="chapter" data-level="7.4" data-path="statistics.html"><a href="statistics.html#-4"><i class="fa fa-check"></i><b>7.4</b> 練習問題</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="appearance.html"><a href="appearance.html"><i class="fa fa-check"></i><b>8</b> 図の体裁</a><ul>
<li class="chapter" data-level="8.1" data-path="appearance.html"><a href="appearance.html#section-8.1"><i class="fa fa-check"></i><b>8.1</b> 軸の反転</a></li>
<li class="chapter" data-level="8.2" data-path="appearance.html"><a href="appearance.html#small-multiple"><i class="fa fa-check"></i><b>8.2</b> Small multiple</a></li>
<li class="chapter" data-level="8.3" data-path="appearance.html"><a href="appearance.html#section-8.3"><i class="fa fa-check"></i><b>8.3</b> テーマ</a></li>
<li class="chapter" data-level="8.4" data-path="appearance.html"><a href="appearance.html#section-8.4"><i class="fa fa-check"></i><b>8.4</b> 色</a></li>
<li class="chapter" data-level="8.5" data-path="appearance.html"><a href="appearance.html#section-8.5"><i class="fa fa-check"></i><b>8.5</b> 軸</a></li>
<li class="chapter" data-level="8.6" data-path="appearance.html"><a href="appearance.html#section-8.6"><i class="fa fa-check"></i><b>8.6</b> 凡例</a></li>
<li class="chapter" data-level="8.7" data-path="appearance.html"><a href="appearance.html#section-8.7"><i class="fa fa-check"></i><b>8.7</b> 複数パネルのグラフ</a></li>
<li class="chapter" data-level="8.8" data-path="appearance.html"><a href="appearance.html#section-8.8"><i class="fa fa-check"></i><b>8.8</b> グラフの保存</a></li>
<li class="chapter" data-level="8.9" data-path="appearance.html"><a href="appearance.html#-5"><i class="fa fa-check"></i><b>8.9</b> 練習問題</a></li>
</ul></li>
<li class="part"><span><b>データハンドリング</b></span></li>
<li class="chapter" data-level="9" data-path="data-handling.html"><a href="data-handling.html"><i class="fa fa-check"></i><b>9</b> データハンドリング</a><ul>
<li class="chapter" data-level="9.1" data-path="data-handling.html"><a href="data-handling.html#tidyverse"><i class="fa fa-check"></i><b>9.1</b> tidyverse</a></li>
<li class="chapter" data-level="9.2" data-path="data-handling.html"><a href="data-handling.html#section-9.2"><i class="fa fa-check"></i><b>9.2</b> 抽出</a><ul>
<li class="chapter" data-level="9.2.1" data-path="data-handling.html"><a href="data-handling.html#section-9.2.1"><i class="fa fa-check"></i><b>9.2.1</b> データの値で絞り込み</a></li>
<li class="chapter" data-level="9.2.2" data-path="data-handling.html"><a href="data-handling.html#section-9.2.2"><i class="fa fa-check"></i><b>9.2.2</b> データの列で絞り込み</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="data-handling.html"><a href="data-handling.html#section-9.3"><i class="fa fa-check"></i><b>9.3</b> 追加</a><ul>
<li class="chapter" data-level="9.3.1" data-path="data-handling.html"><a href="data-handling.html#section-9.3.1"><i class="fa fa-check"></i><b>9.3.1</b> 新しい列を追加</a></li>
<li class="chapter" data-level="9.3.2" data-path="data-handling.html"><a href="data-handling.html#section-9.3.2"><i class="fa fa-check"></i><b>9.3.2</b> 列名を変更</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="data-handling.html"><a href="data-handling.html#section-9.4"><i class="fa fa-check"></i><b>9.4</b> 集約</a></li>
<li class="chapter" data-level="9.5" data-path="data-handling.html"><a href="data-handling.html#section-9.5"><i class="fa fa-check"></i><b>9.5</b> 結合</a></li>
<li class="chapter" data-level="9.6" data-path="data-handling.html"><a href="data-handling.html#section-9.6"><i class="fa fa-check"></i><b>9.6</b> ロングフォーマット</a></li>
<li class="chapter" data-level="9.7" data-path="data-handling.html"><a href="data-handling.html#section-9.7"><i class="fa fa-check"></i><b>9.7</b> データファイルの読み込み</a></li>
<li class="chapter" data-level="9.8" data-path="introduction.html"><a href="introduction.html#ggplot2"><i class="fa fa-check"></i><b>9.8</b> ggplot2と一緒に使う</a></li>
</ul></li>
<li class="part"><span><b>巻末資料</b></span></li>
<li class="chapter" data-level="" data-path="e382aae383b3e383a9e382a4e383b3e8b387e69699.html"><a href="e382aae383b3e383a9e382a4e383b3e8b387e69699.html"><i class="fa fa-check"></i>オンライン資料</a></li>
<li class="chapter" data-level="" data-path="e5ae9fe8a18ce792b0e5a283e383bbe38390e383bce382b8e383a7e383b3e68385e5a0b1.html"><a href="e5ae9fe8a18ce792b0e5a283e383bbe38390e383bce382b8e383a7e383b3e68385e5a0b1.html"><i class="fa fa-check"></i>実行環境・バージョン情報</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">いつか役に立つかもしれない資料</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-handling" class="section level1">
<h1><span class="header-section-number">9</span> データハンドリング</h1>
<p>ここまで、ggplot2を使ったデータの可視化を見てきた。ただし、ggplot2で作図をする際、大きな前提条件がある。それは、<u><strong>データを行列の形で用意しなければいけない</strong></u>というものである。つまり、変数を列に、観測値を行に取るようなデータ構造にあらかじめ整形しなければならないということである。</p>
<p>たとえば、今まで使ってきた<code>mtcars</code>、<code>faithful</code>のデータ構造を改めて見てみよう。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(mtcars) <span class="co"># 先頭6行</span></code></pre></div>
<pre><code>##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(faithful) <span class="co"># 先頭6行</span></code></pre></div>
<pre><code>##   eruptions waiting
## 1     3.600      79
## 2     1.800      54
## 3     3.333      74
## 4     2.283      62
## 5     4.533      85
## 6     2.883      55</code></pre>
<p>どちらも、列に変数名、行に観測値という構造をもっている。</p>
<hr />
<p>散布図、箱ひげ図、ヒストグラムのように、これらのデータの素値をプロットする際、データハンドリングはあまり問題にならない。しかし、実際は平均値や標準誤差のように、何かしらの統計的処理を施した値をプロットしたいこともある。また、ある1つのグループのデータだけをプロットしたいという場合もある。</p>
<p>可視化の際に直面する問題は、おおよそ以下の3つに大別できるだろう。</p>
<ul>
<li><p>1つのグループのデータだけを抽出した上でプロットしたい（たとえば、3条件のうち統制条件だけプロットしたい、など）</p></li>
<li><p>素値ではなく、平均値や標準誤差などの統計量をプロットしたい</p></li>
<li><p>2つ以上のデータフレームを結合してプロットしたい</p></li>
</ul>
<p>などである。</p>
<div id="tidyverse" class="section level2">
<h2><span class="header-section-number">9.1</span> tidyverse</h2>
<p>データハンドリングに使うパッケージ群（複数のパッケージ）はtidyverseと呼ばれており、<code>library(tidyverse)</code>で読み込むことができる。ちなみにggplot2もtidyverseの一部なので、自動的に読み込まれる。下のコードを実行すると色々メッセージが出るかもしれないが、気にしなくて良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse) <span class="co"># データハンドリング用のパッケージおよびggplot2を読み込む</span></code></pre></div>
<p>この章では、主にggplot2の<code>mpg</code>（自動車のデータ）を使い、データハンドリングを見ていくことにする。</p>
</div>
<div id="section-9.2" class="section level2">
<h2><span class="header-section-number">9.2</span> 抽出</h2>
<div id="section-9.2.1" class="section level3">
<h3><span class="header-section-number">9.2.1</span> データの値で絞り込み</h3>
<p>データの値によって絞り込みを行いたい時がある。たとえば、<code>mpg</code>であれば、<code>manufacturer</code>の種類でデータを絞り込みたい（データの行単位で抽出したい）ということである。実際の実験データで言えば、男性／女性のデータのみ抽出したいというような場面である。</p>
<p>このようなときは、<code>filter(抽出条件)</code>を使えば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(manufacturer <span class="op">==</span><span class="st"> &quot;audi&quot;</span>) <span class="co"># manufacturerが&quot;audi&quot;のものだけを抽出</span></code></pre></div>
<pre><code>## # A tibble: 18 x 11
##    manufacturer model displ  year   cyl trans drv     cty   hwy fl    class
##    &lt;chr&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
##  1 audi         a4      1.8  1999     4 auto… f        18    29 p     comp…
##  2 audi         a4      1.8  1999     4 manu… f        21    29 p     comp…
##  3 audi         a4      2    2008     4 manu… f        20    31 p     comp…
##  4 audi         a4      2    2008     4 auto… f        21    30 p     comp…
##  5 audi         a4      2.8  1999     6 auto… f        16    26 p     comp…
##  6 audi         a4      2.8  1999     6 manu… f        18    26 p     comp…
##  7 audi         a4      3.1  2008     6 auto… f        18    27 p     comp…
##  8 audi         a4 q…   1.8  1999     4 manu… 4        18    26 p     comp…
##  9 audi         a4 q…   1.8  1999     4 auto… 4        16    25 p     comp…
## 10 audi         a4 q…   2    2008     4 manu… 4        20    28 p     comp…
## 11 audi         a4 q…   2    2008     4 auto… 4        19    27 p     comp…
## 12 audi         a4 q…   2.8  1999     6 auto… 4        15    25 p     comp…
## 13 audi         a4 q…   2.8  1999     6 manu… 4        17    25 p     comp…
## 14 audi         a4 q…   3.1  2008     6 auto… 4        17    25 p     comp…
## 15 audi         a4 q…   3.1  2008     6 manu… 4        15    25 p     comp…
## 16 audi         a6 q…   2.8  1999     6 auto… 4        15    24 p     mids…
## 17 audi         a6 q…   3.1  2008     6 auto… 4        17    25 p     mids…
## 18 audi         a6 q…   4.2  2008     8 auto… 4        16    23 p     mids…</code></pre>
<p>ここで、<code>==</code>は「等しい」ということを意味している。大体のプログラミング言語では、<code>==</code>が「等しい」<code>=</code>が「代入する」を意味するものである。</p>
<p>ちなみに、<code>%&gt;%</code>はパイプ演算子と呼ばれており、オブジェクトを次の関数の第一引数に突っ込むという操作を表している。ちょっと何を言っているのか分からないと思うが、あまり気にしなくて良い。何をやっているのか、少なくとも直観的には分かるだろう。今はそれで大丈夫である。</p>
<hr />
<p>複数条件で絞り込むこともできる。たとえば、「<code>manufacturer</code>が<code>&quot;audi&quot;</code>」<u><strong>かつ</strong></u>「<code>model</code>が<code>&quot;a4&quot;</code>」の行を抽出したい場合は、条件を<code>&amp;</code>で繋げば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(manufacturer <span class="op">==</span><span class="st"> &quot;audi&quot;</span> <span class="op">&amp;</span><span class="st"> </span>model <span class="op">==</span><span class="st"> &quot;a4&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 7 x 11
##   manufacturer model displ  year   cyl trans  drv     cty   hwy fl    class
##   &lt;chr&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
## 1 audi         a4      1.8  1999     4 auto(… f        18    29 p     comp…
## 2 audi         a4      1.8  1999     4 manua… f        21    29 p     comp…
## 3 audi         a4      2    2008     4 manua… f        20    31 p     comp…
## 4 audi         a4      2    2008     4 auto(… f        21    30 p     comp…
## 5 audi         a4      2.8  1999     6 auto(… f        16    26 p     comp…
## 6 audi         a4      2.8  1999     6 manua… f        18    26 p     comp…
## 7 audi         a4      3.1  2008     6 auto(… f        18    27 p     comp…</code></pre>
<p><br></p>
<p>「<code>manufacturer</code>が<code>&quot;audi&quot;</code>」<u><strong>または</strong></u>「<code>model</code>が<code>&quot;a4&quot;</code>」の行を抽出したい場合は、条件を<code>|</code>で繋げば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(manufacturer <span class="op">==</span><span class="st"> &quot;audi&quot;</span> <span class="op">|</span><span class="st"> </span>model <span class="op">==</span><span class="st"> &quot;a4&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 18 x 11
##    manufacturer model displ  year   cyl trans drv     cty   hwy fl    class
##    &lt;chr&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
##  1 audi         a4      1.8  1999     4 auto… f        18    29 p     comp…
##  2 audi         a4      1.8  1999     4 manu… f        21    29 p     comp…
##  3 audi         a4      2    2008     4 manu… f        20    31 p     comp…
##  4 audi         a4      2    2008     4 auto… f        21    30 p     comp…
##  5 audi         a4      2.8  1999     6 auto… f        16    26 p     comp…
##  6 audi         a4      2.8  1999     6 manu… f        18    26 p     comp…
##  7 audi         a4      3.1  2008     6 auto… f        18    27 p     comp…
##  8 audi         a4 q…   1.8  1999     4 manu… 4        18    26 p     comp…
##  9 audi         a4 q…   1.8  1999     4 auto… 4        16    25 p     comp…
## 10 audi         a4 q…   2    2008     4 manu… 4        20    28 p     comp…
## 11 audi         a4 q…   2    2008     4 auto… 4        19    27 p     comp…
## 12 audi         a4 q…   2.8  1999     6 auto… 4        15    25 p     comp…
## 13 audi         a4 q…   2.8  1999     6 manu… 4        17    25 p     comp…
## 14 audi         a4 q…   3.1  2008     6 auto… 4        17    25 p     comp…
## 15 audi         a4 q…   3.1  2008     6 manu… 4        15    25 p     comp…
## 16 audi         a6 q…   2.8  1999     6 auto… 4        15    24 p     mids…
## 17 audi         a6 q…   3.1  2008     6 auto… 4        17    25 p     mids…
## 18 audi         a6 q…   4.2  2008     8 auto… 4        16    23 p     mids…</code></pre>
<p><br></p>
<p>「<code>manufacturer</code>が<code>&quot;audi&quot;</code>」<u><strong>でもなく</strong></u>「<code>model</code>が<code>&quot;a4&quot;</code>」<u><strong>でもない</strong></u>行を抽出したい場合は、条件を<code>!()</code>で囲めば良い。<code>!()</code>は論理値を反転させる演算子である<a href="#fn29" class="footnoteRef" id="fnref29"><sup>29</sup></a>。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>(manufacturer <span class="op">==</span><span class="st"> &quot;audi&quot;</span> <span class="op">|</span><span class="st"> </span>model <span class="op">==</span><span class="st"> &quot;a4&quot;</span>))</code></pre></div>
<pre><code>## # A tibble: 216 x 11
##    manufacturer model displ  year   cyl trans drv     cty   hwy fl    class
##    &lt;chr&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
##  1 chevrolet    c150…   5.3  2008     8 auto… r        14    20 r     suv  
##  2 chevrolet    c150…   5.3  2008     8 auto… r        11    15 e     suv  
##  3 chevrolet    c150…   5.3  2008     8 auto… r        14    20 r     suv  
##  4 chevrolet    c150…   5.7  1999     8 auto… r        13    17 r     suv  
##  5 chevrolet    c150…   6    2008     8 auto… r        12    17 r     suv  
##  6 chevrolet    corv…   5.7  1999     8 manu… r        16    26 p     2sea…
##  7 chevrolet    corv…   5.7  1999     8 auto… r        15    23 p     2sea…
##  8 chevrolet    corv…   6.2  2008     8 manu… r        16    26 p     2sea…
##  9 chevrolet    corv…   6.2  2008     8 auto… r        15    25 p     2sea…
## 10 chevrolet    corv…   7    2008     8 manu… r        15    24 p     2sea…
## # … with 206 more rows</code></pre>
</div>
<div id="section-9.2.2" class="section level3">
<h3><span class="header-section-number">9.2.2</span> データの列で絞り込み</h3>
<p>では、列方向で抽出するにはどうすれば良いのだろうか？　たとえば、<code>mpg</code>で言えば、<code>manufacturer</code>と<code>model</code>と<code>trans</code>と<code>drv</code>の列を抽出したいというような状況である。</p>
<p>このようなときは、<code>select(抽出したい列名)</code>を使えば良い。抽出したい列名は、1つだけに限らず、何個書いても問題ない。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(manufacturer, model, trans, drv) <span class="co"># 4つの列を抽出</span></code></pre></div>
<pre><code>## # A tibble: 234 x 4
##    manufacturer model      trans      drv  
##    &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;
##  1 audi         a4         auto(l5)   f    
##  2 audi         a4         manual(m5) f    
##  3 audi         a4         manual(m6) f    
##  4 audi         a4         auto(av)   f    
##  5 audi         a4         auto(l5)   f    
##  6 audi         a4         manual(m5) f    
##  7 audi         a4         auto(av)   f    
##  8 audi         a4 quattro manual(m5) 4    
##  9 audi         a4 quattro auto(l5)   4    
## 10 audi         a4 quattro manual(m6) 4    
## # … with 224 more rows</code></pre>
<p><br></p>
<p><code>select()</code>では、「A列からG列まで」というような抽出も可能である。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(manufacturer<span class="op">:</span>drv) <span class="co"># manufacturerからdrvまでの7列を抽出</span></code></pre></div>
<pre><code>## # A tibble: 234 x 7
##    manufacturer model      displ  year   cyl trans      drv  
##    &lt;chr&gt;        &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;
##  1 audi         a4           1.8  1999     4 auto(l5)   f    
##  2 audi         a4           1.8  1999     4 manual(m5) f    
##  3 audi         a4           2    2008     4 manual(m6) f    
##  4 audi         a4           2    2008     4 auto(av)   f    
##  5 audi         a4           2.8  1999     6 auto(l5)   f    
##  6 audi         a4           2.8  1999     6 manual(m5) f    
##  7 audi         a4           3.1  2008     6 auto(av)   f    
##  8 audi         a4 quattro   1.8  1999     4 manual(m5) 4    
##  9 audi         a4 quattro   1.8  1999     4 auto(l5)   4    
## 10 audi         a4 quattro   2    2008     4 manual(m6) 4    
## # … with 224 more rows</code></pre>
<p><br></p>
<p>指定した列を除外することもできる<code>select(-列名)</code>とすれば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>manufacturer) <span class="co"># manufacturerを除外</span></code></pre></div>
<pre><code>## # A tibble: 234 x 10
##    model      displ  year   cyl trans      drv     cty   hwy fl    class  
##    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;      &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;  
##  1 a4           1.8  1999     4 auto(l5)   f        18    29 p     compact
##  2 a4           1.8  1999     4 manual(m5) f        21    29 p     compact
##  3 a4           2    2008     4 manual(m6) f        20    31 p     compact
##  4 a4           2    2008     4 auto(av)   f        21    30 p     compact
##  5 a4           2.8  1999     6 auto(l5)   f        16    26 p     compact
##  6 a4           2.8  1999     6 manual(m5) f        18    26 p     compact
##  7 a4           3.1  2008     6 auto(av)   f        18    27 p     compact
##  8 a4 quattro   1.8  1999     4 manual(m5) 4        18    26 p     compact
##  9 a4 quattro   1.8  1999     4 auto(l5)   4        16    25 p     compact
## 10 a4 quattro   2    2008     4 manual(m6) 4        20    28 p     compact
## # … with 224 more rows</code></pre>
</div>
</div>
<div id="section-9.3" class="section level2">
<h2><span class="header-section-number">9.3</span> 追加</h2>
<div id="section-9.3.1" class="section level3">
<h3><span class="header-section-number">9.3.1</span> 新しい列を追加</h3>
<p>データフレームに新しい列を作るには、<code>mutate(新しく作る列名 = 値)</code>を使えば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">one =</span> <span class="dv">1</span>) <span class="co"># 最後尾にoneという列を追加した</span></code></pre></div>
<pre><code>## # A tibble: 234 x 12
##    manufacturer model displ  year   cyl trans drv     cty   hwy fl    class
##    &lt;chr&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
##  1 audi         a4      1.8  1999     4 auto… f        18    29 p     comp…
##  2 audi         a4      1.8  1999     4 manu… f        21    29 p     comp…
##  3 audi         a4      2    2008     4 manu… f        20    31 p     comp…
##  4 audi         a4      2    2008     4 auto… f        21    30 p     comp…
##  5 audi         a4      2.8  1999     6 auto… f        16    26 p     comp…
##  6 audi         a4      2.8  1999     6 manu… f        18    26 p     comp…
##  7 audi         a4      3.1  2008     6 auto… f        18    27 p     comp…
##  8 audi         a4 q…   1.8  1999     4 manu… 4        18    26 p     comp…
##  9 audi         a4 q…   1.8  1999     4 auto… 4        16    25 p     comp…
## 10 audi         a4 q…   2    2008     4 manu… 4        20    28 p     comp…
## # … with 224 more rows, and 1 more variable: one &lt;dbl&gt;</code></pre>
<p><br></p>
<p>上の例では<code>one</code>という列を作り、すべての行を1で埋めたが、これはあまり実践的ではない。</p>
<p><code>mutate()</code>が力を発揮するのは、特に<code>if_else()</code>という関数と組み合わせたときである。たとえば、<code>displ</code>（排気量）の値が3未満なら<code>good</code>、3以上なら<code>bad</code>という列（<code>engine</code>）を作りたい場合、以下のように書けば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">engine =</span> <span class="kw">if_else</span>(displ <span class="op">&lt;</span><span class="st"> </span><span class="dv">3</span>, <span class="st">&quot;good&quot;</span>, <span class="st">&quot;bad&quot;</span>))</code></pre></div>
<pre><code>## # A tibble: 234 x 12
##    manufacturer model displ  year   cyl trans drv     cty   hwy fl    class
##    &lt;chr&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
##  1 audi         a4      1.8  1999     4 auto… f        18    29 p     comp…
##  2 audi         a4      1.8  1999     4 manu… f        21    29 p     comp…
##  3 audi         a4      2    2008     4 manu… f        20    31 p     comp…
##  4 audi         a4      2    2008     4 auto… f        21    30 p     comp…
##  5 audi         a4      2.8  1999     6 auto… f        16    26 p     comp…
##  6 audi         a4      2.8  1999     6 manu… f        18    26 p     comp…
##  7 audi         a4      3.1  2008     6 auto… f        18    27 p     comp…
##  8 audi         a4 q…   1.8  1999     4 manu… 4        18    26 p     comp…
##  9 audi         a4 q…   1.8  1999     4 auto… 4        16    25 p     comp…
## 10 audi         a4 q…   2    2008     4 manu… 4        20    28 p     comp…
## # … with 224 more rows, and 1 more variable: engine &lt;chr&gt;</code></pre>
</div>
<div id="section-9.3.2" class="section level3">
<h3><span class="header-section-number">9.3.2</span> 列名を変更</h3>
<p>新しい列を作りたいわけではないが、列名を変えたい場合がある。このようなときは、<code>rename(新しい列名 = 古い列名)</code>を使えば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">nen =</span> year) <span class="co"># yearをnenに変更</span></code></pre></div>
<pre><code>## # A tibble: 234 x 11
##    manufacturer model displ   nen   cyl trans drv     cty   hwy fl    class
##    &lt;chr&gt;        &lt;chr&gt; &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
##  1 audi         a4      1.8  1999     4 auto… f        18    29 p     comp…
##  2 audi         a4      1.8  1999     4 manu… f        21    29 p     comp…
##  3 audi         a4      2    2008     4 manu… f        20    31 p     comp…
##  4 audi         a4      2    2008     4 auto… f        21    30 p     comp…
##  5 audi         a4      2.8  1999     6 auto… f        16    26 p     comp…
##  6 audi         a4      2.8  1999     6 manu… f        18    26 p     comp…
##  7 audi         a4      3.1  2008     6 auto… f        18    27 p     comp…
##  8 audi         a4 q…   1.8  1999     4 manu… 4        18    26 p     comp…
##  9 audi         a4 q…   1.8  1999     4 auto… 4        16    25 p     comp…
## 10 audi         a4 q…   2    2008     4 manu… 4        20    28 p     comp…
## # … with 224 more rows</code></pre>
</div>
</div>
<div id="section-9.4" class="section level2">
<h2><span class="header-section-number">9.4</span> 集約</h2>
<p>統計量の算出に使えるのは、<code>group_by()</code>と<code>summarise()</code>である。</p>
<p>まずは<code>summarise()</code>を見てみよう。書き方は<code>summarise(新しい列名 = 関数)</code>である。同時に複数の関数を使うこともできる。たとえば、<code>displ</code>の平均値、標準偏差、最小値、最大値を計算したい場合、以下のように書けば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_displ =</span> <span class="kw">mean</span>(displ),
            <span class="dt">sd_displ =</span> <span class="kw">sd</span>(displ),
            <span class="dt">min_displ =</span> <span class="kw">min</span>(displ),
            <span class="dt">max_displ =</span> <span class="kw">max</span>(displ))</code></pre></div>
<pre><code>## # A tibble: 1 x 4
##   mean_displ sd_displ min_displ max_displ
##        &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1       3.47     1.29       1.6         7</code></pre>
<p>このように、<code>summarise()</code>を使うと、データ全体の統計量を計算することができる。</p>
<hr />
<p>しかし、実際の場面で全体の統計量を計算することは少なく、むしろグループごとの統計量を計算したいという場面のほうが圧倒的に多いだろう。</p>
<p>このようなときは、<code>group_by(グルーピングの変数)</code>を使うことができる。たとえば、<code>year</code>ごとに<code>summarise()</code>を実行するには、以下のように書けば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean_displ =</span> <span class="kw">mean</span>(displ),
            <span class="dt">sd_displ =</span> <span class="kw">sd</span>(displ),
            <span class="dt">min_displ =</span> <span class="kw">min</span>(displ),
            <span class="dt">max_displ =</span> <span class="kw">max</span>(displ))</code></pre></div>
<pre><code>## # A tibble: 2 x 5
##    year mean_displ sd_displ min_displ max_displ
##   &lt;int&gt;      &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1  1999       3.28     1.26       1.6       6.5
## 2  2008       3.66     1.30       1.8       7</code></pre>
<p>製造年（1999年と2008年）ごとに統計量を計算することができた。</p>
</div>
<div id="section-9.5" class="section level2">
<h2><span class="header-section-number">9.5</span> 結合</h2>
<p>ここでは、<code>mpg</code>ではなく、架空のデータセットを作ってみよう。たとえば、以下のような状況を考えてみてほしい。</p>
<p><br></p>
<blockquote>
<p>たかし君とはなこさんは、以前見たテレビドラマを思い出して「足袋を履いたときと、裸足のときとで、どっちが走るのが早くなるだろうか？」と疑問に思いました。そこで2人は、5日間のうち3日は足袋を履いて、2日は裸足で自宅から学校まで走り、到着までの所要時間を測りました。</p>
</blockquote>
<p><br></p>
<p>2人の毎日の所要時間データは<code>commute</code>というデータフレームとして保存しよう。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">commute =<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="st">&quot;name&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;takashi&quot;</span>,<span class="st">&quot;takashi&quot;</span>,<span class="st">&quot;takashi&quot;</span>,<span class="st">&quot;takashi&quot;</span>,<span class="st">&quot;takashi&quot;</span>,<span class="st">&quot;hanako&quot;</span>,<span class="st">&quot;hanako&quot;</span>,<span class="st">&quot;hanako&quot;</span>,<span class="st">&quot;hanako&quot;</span>,<span class="st">&quot;hanako&quot;</span>),
  <span class="st">&quot;day&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>),
  <span class="st">&quot;time&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">13</span>,<span class="dv">12</span>,<span class="dv">11</span>,<span class="dv">14</span>,<span class="dv">9</span>,<span class="dv">15</span>,<span class="dv">14</span>,<span class="dv">10</span>,<span class="dv">16</span>)
)

commute</code></pre></div>
<pre><code>##       name day time
## 1  takashi   1   10
## 2  takashi   2   13
## 3  takashi   3   12
## 4  takashi   4   11
## 5  takashi   5   14
## 6   hanako   1    9
## 7   hanako   2   15
## 8   hanako   3   14
## 9   hanako   4   10
## 10  hanako   5   16</code></pre>
<p>一方、足袋だったか裸足だったかは、<code>shoes</code>というデータフレームとして保存しよう。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">shoes =<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="st">&quot;day&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>),
  <span class="st">&quot;shoes&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;tabi&quot;</span>,<span class="st">&quot;tabi&quot;</span>,<span class="st">&quot;bare&quot;</span>,<span class="st">&quot;tabi&quot;</span>,<span class="st">&quot;bare&quot;</span>)
)

shoes</code></pre></div>
<pre><code>##   day shoes
## 1   1  tabi
## 2   2  tabi
## 3   3  bare
## 4   4  tabi
## 5   5  bare</code></pre>
<p><br></p>
<p>このようなとき、所要時間のデータと毎日の靴のデータを関係づけて可視化したいものである。しかし、別々のデータフレームとして保存されているので、今のままでは可視化できない。</p>
<p>このようなときは、<code>inner_join()</code>という関数を使えば良い。書き方は、<code>inner_join(結合するデータ, by = &quot;共通の列名&quot;)</code>である。今回は、<code>day</code>という変数が共通なので、以下のように書けば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">commute <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(shoes, <span class="dt">by =</span> <span class="st">&quot;day&quot;</span>)</code></pre></div>
<pre><code>##       name day time shoes
## 1  takashi   1   10  tabi
## 2  takashi   2   13  tabi
## 3  takashi   3   12  bare
## 4  takashi   4   11  tabi
## 5  takashi   5   14  bare
## 6   hanako   1    9  tabi
## 7   hanako   2   15  tabi
## 8   hanako   3   14  bare
## 9   hanako   4   10  tabi
## 10  hanako   5   16  bare</code></pre>
<p>無事2つのデータを結合することができた。</p>
<hr />
<p>しかし、いつも共通の列名があるわけではない。たとえば、<code>shoes</code>が以下のようになっていたとしよう。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">shoes =<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="st">&quot;hinichi&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>), <span class="co"># &quot;day&quot;ではなく、&quot;hinichi&quot;という列名</span>
  <span class="st">&quot;shoes&quot;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;tabi&quot;</span>,<span class="st">&quot;tabi&quot;</span>,<span class="st">&quot;bare&quot;</span>,<span class="st">&quot;tabi&quot;</span>,<span class="st">&quot;bare&quot;</span>)
)

shoes</code></pre></div>
<pre><code>##   hinichi shoes
## 1       1  tabi
## 2       2  tabi
## 3       3  bare
## 4       4  tabi
## 5       5  bare</code></pre>
<p>このようなときは、以下のように書けば良い。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">commute <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">inner_join</span>(shoes, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;day&quot;</span> =<span class="st"> &quot;hinichi&quot;</span>)) <span class="co"># dayとhinichiを対応づけている</span></code></pre></div>
<pre><code>##       name day time shoes
## 1  takashi   1   10  tabi
## 2  takashi   2   13  tabi
## 3  takashi   3   12  bare
## 4  takashi   4   11  tabi
## 5  takashi   5   14  bare
## 6   hanako   1    9  tabi
## 7   hanako   2   15  tabi
## 8   hanako   3   14  bare
## 9   hanako   4   10  tabi
## 10  hanako   5   16  bare</code></pre>
<p>この他にも<code>left_join()</code>、<code>right_join()</code>などの関数がある。詳しくは、<a href="https://dplyr.tidyverse.org/reference/join.html" class="uri">https://dplyr.tidyverse.org/reference/join.html</a> を見てほしい。</p>
</div>
<div id="section-9.6" class="section level2">
<h2><span class="header-section-number">9.6</span> ロングフォーマット</h2>
<p>以下の架空のデータフレーム（X, Y, Zという3つの株価の増減比の時系列データ）があるとしよう。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1</span>)
stocks =<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">time =</span> <span class="kw">as.Date</span>(<span class="st">&#39;2009-01-01&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="dv">0</span><span class="op">:</span><span class="dv">9</span>,
  <span class="dt">X =</span> <span class="kw">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">1</span>),
  <span class="dt">Y =</span> <span class="kw">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">2</span>),
  <span class="dt">Z =</span> <span class="kw">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">4</span>)
)

stocks</code></pre></div>
<pre><code>##          time          X           Y          Z
## 1  2009-01-01 -0.6264538  3.02356234  3.6759095
## 2  2009-01-02  0.1836433  0.77968647  3.1285452
## 3  2009-01-03 -0.8356286 -1.24248116  0.2982599
## 4  2009-01-04  1.5952808 -4.42939977 -7.9574068
## 5  2009-01-05  0.3295078  2.24986184  2.4793030
## 6  2009-01-06 -0.8204684 -0.08986722 -0.2245150
## 7  2009-01-07  0.4874291 -0.03238053 -0.6231820
## 8  2009-01-08  0.7383247  1.88767242 -5.8830095
## 9  2009-01-09  0.5757814  1.64244239 -1.9126002
## 10 2009-01-10 -0.3053884  1.18780264  1.6717662</code></pre>
<p><br></p>
<p>このとき、3つの株価の時系列変化をプロットしてみたいが、このままではうまくいかない。なぜなら、データがロングフォーマット（列に変数名、行にデータ）という形式になっていないからである。このようなデータをワイドフォーマットと言う。</p>
<p>データをロングフォーマットに変えるには、<code>gather()</code>を使えば良い。書き方は、<code>gather(key = &quot;新しく作るラベル&quot;, value = &quot;新しく作る数値&quot;, ロングにしたい列（複数個）)</code>である。文章ではわかりにくいと思うので、以下のコードを見てほしい。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stocks_long =<span class="st"> </span>stocks <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> stock, <span class="dt">value =</span> price, X, Y, Z) <span class="co"># X:Zで指定してもOK</span>

stocks_long</code></pre></div>
<pre><code>##          time stock       price
## 1  2009-01-01     X -0.62645381
## 2  2009-01-02     X  0.18364332
## 3  2009-01-03     X -0.83562861
## 4  2009-01-04     X  1.59528080
## 5  2009-01-05     X  0.32950777
## 6  2009-01-06     X -0.82046838
## 7  2009-01-07     X  0.48742905
## 8  2009-01-08     X  0.73832471
## 9  2009-01-09     X  0.57578135
## 10 2009-01-10     X -0.30538839
## 11 2009-01-01     Y  3.02356234
## 12 2009-01-02     Y  0.77968647
## 13 2009-01-03     Y -1.24248116
## 14 2009-01-04     Y -4.42939977
## 15 2009-01-05     Y  2.24986184
## 16 2009-01-06     Y -0.08986722
## 17 2009-01-07     Y -0.03238053
## 18 2009-01-08     Y  1.88767242
## 19 2009-01-09     Y  1.64244239
## 20 2009-01-10     Y  1.18780264
## 21 2009-01-01     Z  3.67590949
## 22 2009-01-02     Z  3.12854520
## 23 2009-01-03     Z  0.29825993
## 24 2009-01-04     Z -7.95740678
## 25 2009-01-05     Z  2.47930299
## 26 2009-01-06     Z -0.22451496
## 27 2009-01-07     Z -0.62318203
## 28 2009-01-08     Z -5.88300954
## 29 2009-01-09     Z -1.91260022
## 30 2009-01-10     Z  1.67176624</code></pre>
<p>ロングフォーマットにすることができた。</p>
<hr />
<p>元のワイドフォーマットに戻したい場合は、<code>spread()</code>を使えば良い。書き方は<code>spread(key = ワイドにする列, value = ワイドにする値)</code>である。これも文章ではわかりにくいと思うので、以下のコードを見てほしい。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stocks_long <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(stock, price)</code></pre></div>
<pre><code>##          time          X           Y          Z
## 1  2009-01-01 -0.6264538  3.02356234  3.6759095
## 2  2009-01-02  0.1836433  0.77968647  3.1285452
## 3  2009-01-03 -0.8356286 -1.24248116  0.2982599
## 4  2009-01-04  1.5952808 -4.42939977 -7.9574068
## 5  2009-01-05  0.3295078  2.24986184  2.4793030
## 6  2009-01-06 -0.8204684 -0.08986722 -0.2245150
## 7  2009-01-07  0.4874291 -0.03238053 -0.6231820
## 8  2009-01-08  0.7383247  1.88767242 -5.8830095
## 9  2009-01-09  0.5757814  1.64244239 -1.9126002
## 10 2009-01-10 -0.3053884  1.18780264  1.6717662</code></pre>
<p>ワイドフォーマットに戻すことができた。</p>
</div>
<div id="section-9.7" class="section level2">
<h2><span class="header-section-number">9.7</span> データファイルの読み込み</h2>
<p>実際のデータファイル（たとえばcsv、tsv、xlsxなどのスプレッドシート）は、<code>read_csv()</code>や<code>read_tsv()</code>、readxlパッケージの<code>read_excel()</code>で読み込むことができる。</p>
<p>データの読み込みについては、各人の都合があると思うので、周りの人に尋ねてみてほしい<a href="#fn30" class="footnoteRef" id="fnref30"><sup>30</sup></a>。</p>
</div>
<div id="ggplot2" class="section level2">
<h2><span class="header-section-number">9.8</span> ggplot2と一緒に使う</h2>
<p>パイプ演算子（<code>%&gt;%</code>）を使うと、以下のようにデータハンドリングと可視化をシームレスにつなげることができる。下の例では、平均値と標準誤差をグループごとに計算し、棒グラフとエラーバーを描いている。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mpg <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># yearごとに</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(displ),
            <span class="dt">se =</span> <span class="kw">sd</span>(displ) <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">n</span>())) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># 平均値と標準誤差を計算；n()はデータの個数を数える関数</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="kw">factor</span>(year), mean, <span class="dt">fill =</span> <span class="kw">factor</span>(year))) <span class="op">+</span><span class="st"> </span><span class="co"># dataは「%&gt;%」で自動的に流し込まれているので、指定しなくて良い</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> mean <span class="op">-</span><span class="st"> </span>se, <span class="dt">ymax =</span> mean <span class="op">+</span><span class="st"> </span>se), <span class="dt">width =</span> <span class="fl">0.2</span>)</code></pre></div>
<p><img src="lecture_note_files/figure-html/unnamed-chunk-125-1.png" width="768" style="display: block; margin: auto;" /></p>

</div>
</div>



<div class="footnotes">
<hr />
<ol start="29">
<li id="fn29"><p>ちなみに「<code>manufacturer</code>が<code>&quot;audi&quot;</code>ではない」を書きたいときは、<code>manufacturer != &quot;audi&quot;</code>とすれば良い。<a href="data-handling.html#fnref29">↩</a></p></li>
<li id="fn30"><p>「言語化して説明するのが大変」とは言えない。<a href="data-handling.html#fnref30">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="appearance.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="e382aae383b3e383a9e382a4e383b3e8b387e69699.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["lecture_note.pdf", "lecture_note.epub"],
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true
});
});
</script>

</body>

</html>
